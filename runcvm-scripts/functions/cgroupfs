cgroupfs_mount() {
  local cgroupfs="$1"

  # We want no cgroupfs at all, or we will leave it to the distribution.
  if [ "$cgroupfs" = "none" ] || [ "$cgroupfs" = "systemd" ]; then
    mount -t cgroup -o none,name=systemd cgroup /sys/fs/cgroup/systemd
  fi

  # If defined in fstab, or there's no kernel support, skip.
  # see also https://github.com/tianon/cgroupfs-mount/blob/master/cgroupfs-mount
  if grep -v '^#' /etc/fstab | grep -q cgroup \
    || [ ! -e /proc/cgroups ] \
    || [ ! -d /sys/fs/cgroup ]; then
      return
  fi

  # 1. cgroup v1 "hybrid" (default)
  # Mount cgroup v2 on /sys/fs/cgroup/unified
  # Mount cgroup v1 controllers on /sys/fs/cgroup/<controller>
  
  if [ "$cgroupfs" = "hybrid" ] || [ "$cgroupfs" = "mixed" ] || [ "$cgroupfs" = "1" ] || [ "$cgroupfs" = "cgroup1" ]; then
    if ! findmnt -rnu -M /sys/fs/cgroup; then
      mount -t tmpfs -o uid=0,gid=0,mode=0755 cgroup /sys/fs/cgroup
    fi
    mkdir -p /sys/fs/cgroup/unified
    mount -t cgroup2 cgroup2 /sys/fs/cgroup/unified || true
  fi

  # Mount all v1 controllers
  # If 1 (hybrid) or legacy
  
  if [ "$cgroupfs" = "hybrid" ] || [ "$cgroupfs" = "mixed" ]; then
    # Mount v1 controllers
    for subsys in $(awk '!/^#/ {print $1}' /proc/cgroups); do
        mkdir -p /sys/fs/cgroup/$subsys
        mount -t cgroup -o $subsys cgroup /sys/fs/cgroup/$subsys || true
    done
  fi
  
  # 2. cgroup v2 "unified"
  if [ "$cgroupfs" = "2" ] || [ "$cgroupfs" = "cgroup2" ]; then
    if ! findmnt -rnu -M /sys/fs/cgroup; then
      mount -t tmpfs -o uid=0,gid=0,mode=0755 cgroup /sys/fs/cgroup 2>/dev/null || true
    fi
    if ! findmnt -rnu -M /sys/fs/cgroup; then
      mkdir -p /sys/fs/cgroup
      mount -t cgroup2 -o rw,nosuid,nodev,noexec,relatime cgroup2 /sys/fs/cgroup
    fi
  fi
}