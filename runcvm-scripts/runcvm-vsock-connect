#!/bin/sh
# runcvm-vsock-connect
# Connect to Firecracker VSOCK UDS and perform handshake
# Usage: runcvm-vsock-connect <uds_path> <port>

UDS_PATH="$1"
PORT="$2"

if [ -z "$UDS_PATH" ] || [ -z "$PORT" ]; then
  echo "Usage: $0 <uds_path> <port>" >&2
  exit 1
fi

# Handshake: "CONNECT <port>\n"
# We pipe this handshake into the socket, followed by stdin (for the actual connection data).
# We rely on socat to bidirectionally forward stdin/stdout to the socket.
# The handshake must be the FIRST thing sent.

# Using { printf...; cat; } | socat ... works for sending TO the socket.
# But socat also sends FROM the socket to stdout.
# The `cat` reads from this script's stdin (which is the client's data).

# NOTE: We use `socat` with `STDIO` to connect this script's stdin/stdout to the socket.
# But we need to inject the handshake.

# Detect socat
if command -v socat >/dev/null 2>&1; then
    SOCAT_BIN="socat"
elif [ -x "/.runcvm/guest/usr/bin/socat" ]; then
    SOCAT_BIN="/.runcvm/guest/usr/bin/socat"
else
    # Fallback if socat is missing
    echo "Error: socat not found" >&2
    exit 1
fi

# Inject handshake then switch to transparent forwarding
{ printf "CONNECT %s\n" "$PORT"; cat; } | $SOCAT_BIN UNIX-CONNECT:"$UDS_PATH" -

fi
