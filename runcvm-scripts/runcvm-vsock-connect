#!/bin/sh
# runcvm-vsock-connect
# Connects to Firecracker UDS, handles handshake, and forwards IO unbuffered.

UDS_PATH="$1"
PORT="$2"

if [ -z "$UDS_PATH" ] || [ -z "$PORT" ]; then
  echo "Usage: $0 <uds_path> <port>" >&2
  exit 1
fi

# Detect socat (prefer bundled)
SOCAT_BIN="/.runcvm/guest/usr/bin/socat"
if [ ! -x "$SOCAT_BIN" ]; then
    SOCAT_BIN="socat"
fi

# Firecracker VSOCK Handshake via socat:
# 1. Send "CONNECT <port>\n" to the UDS
# 2. Read "OK <assigned_port>\n" response  
# 3. Forward remaining bidirectional data

# We use a subshell pipeline:
# - printf sends the handshake
# - cat forwards stdin to socat
# - socat connects to UDS and forwards output back
# - We consume the "OK" line before passing data through

{
    # Send handshake
    printf "CONNECT %s\n" "$PORT"
    # Forward all remaining stdin
    exec cat
} | $SOCAT_BIN - UNIX-CONNECT:"$UDS_PATH" | {
    # Read and discard the "OK" handshake response line
    IFS= read -r response_line
    # Now forward all remaining data to stdout
    exec cat
}
