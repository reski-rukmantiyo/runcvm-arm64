#!/usr/bin/python3
# runcvm-vsock-connect
# Connects to Firecracker UDS, handles handshake, and forwards IO unbuffered.
import socket
import sys
import threading
import traceback

def log_error(msg):
    print(f"[vsock-connect ERROR] {msg}", file=sys.stderr, flush=True)

def forward(src, dst):
    try:
        while True:
            data = src.read(32768)
            if not data:
                break
            dst.write(data)
            dst.flush()
    except Exception as e:
        log_error(f"Forward error: {e}")
    finally:
        try:
            dst.close()
        except:
            pass

def main():
    try:
        if len(sys.argv) < 3:
            log_error(f"Usage: {sys.argv[0]} <uds_path> <port>")
            sys.exit(1)

        uds_path = sys.argv[1]
        port = sys.argv[2]

        s = socket.socket(socket.AF_UNIX, socket.SOCK_STREAM)
        s.connect(uds_path)
        
        # Send handshake
        s.sendall(f"CONNECT {port}\n".encode())
        
        # Read OK line
        f = s.makefile('rb', buffering=0)
        line = f.readline()
        if not line.startswith(b"OK"):
            log_error(f"Handshake failed: {line.decode().strip()}")
            sys.exit(1)
            
        # Start bidirectional forwarding
        # Peer -> Client
        t = threading.Thread(target=forward, args=(f, sys.stdout.buffer), daemon=True)
        t.start()
        
        # Client -> Peer
        peer_out = s.makefile('wb', buffering=0)
        forward(sys.stdin.buffer, peer_out)
        
    except Exception as e:
        log_error(f"Main error: {e}")
        traceback.print_exc(file=sys.stderr)
        sys.exit(1)

if __name__ == "__main__":
    main()
