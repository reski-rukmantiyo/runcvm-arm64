#!/bin/bash
# runcvm-vsock-connect
# Connects to Firecracker UDS, handles handshake, and forwards IO unbuffered.

exec 2>>/tmp/vsock-connect.log
echo "[$(date)] VSOCK-CONNECT STARTED: $*" >&2

UDS_PATH="$1"
PORT="$2"

if [ -z "$UDS_PATH" ] || [ -z "$PORT" ]; then
  echo "Usage: $0 <uds_path> <port>" >&2
  exit 1
fi

RUNCVM_GUEST=${RUNCVM_GUEST:-/.runcvm/guest}
SOCAT_BIN="$RUNCVM_GUEST/usr/bin/socat"
[ ! -x "$SOCAT_BIN" ] && SOCAT_BIN="socat"

# Helper for the handshake skip
skip_handshake() {
    echo "DEBUG: Skipping handshake..." >&2
    # Read characters one by one until a newline is found.
    local char
    while IFS='' read -r -n 1 char; do
        byte=$(printf '%s' "$char" | od -An -t u1 | tr -d ' ')
        echo "DEBUG: Read byte: $byte ($char)" >&2
        if [[ "$char" == $'\n' ]]; then
            echo "DEBUG: Handshake line end found." >&2
            break
        fi
    done
    echo "DEBUG: Handshake skipped. Starting forwarders..." >&2
    # Forward the rest of the stream
    cat
}

echo "DEBUG: Connecting to $UDS_PATH for port $PORT" >&2
if [ ! -S "$UDS_PATH" ]; then
  echo "ERROR: UDS socket not found at $UDS_PATH" >&2
  exit 1
fi

{
    printf "CONNECT %s\n" "$PORT"
    cat
} | $SOCAT_BIN - UNIX-CONNECT:"$UDS_PATH" | skip_handshake
