#!/bin/sh

echo "[VM-START] Script started (PID $$)" > /dev/console

# Load original environment
if [ -f /.runcvm/config ]; then
  . /.runcvm/config
fi

# Load defaults and aliases
# Check if defaults exists first
if [ -f "$RUNCVM_GUEST/scripts/runcvm-ctr-defaults" ]; then
    . $RUNCVM_GUEST/scripts/runcvm-ctr-defaults
else
    echo "[VM-START] WARNING: runcvm-ctr-defaults not found!" > /dev/console
fi

echo "[VM-START] Defaults loaded" > /dev/console

if [ -f /.runcvm/once ]; then
  poweroff
  exit 0
else
  touch /.runcvm/once
fi

# Change to saved PWD
if [ -f /.runcvm/pwd ]; then
  cd $(cat /.runcvm/pwd) && unset OLDPWD
else
  cd /
fi

echo "[VM-START] PWD set" > /dev/console

# Reload original environment again to be sure
if [ -f /.runcvm/config ]; then
  . /.runcvm/config
fi

# Cache paths before cleaning
S6_BINARY="$RUNCVM_GUEST/bin/s6-applyuidgid"

# Clean RUNCVM env vars
clean_env

# Default UID/GID if broken logic above
RUNCVM_UIDGID="${RUNCVM_UIDGID:-0:0:0}"

echo "[VM-START] UIDGID: $RUNCVM_UIDGID" > /dev/console

# Parse UID/GID
uid=$(echo "$RUNCVM_UIDGID" | cut -d: -f1)
gid=$(echo "$RUNCVM_UIDGID" | cut -d: -f2)
additionalGids=$(echo "$RUNCVM_UIDGID" | cut -d: -f3-)

echo "[VM-START] Parsed: uid=$uid gid=$gid additionalGids=$additionalGids" > /dev/console

# Load original entrypoint (POSIX compliant)
if [ -f /.runcvm/entrypoint ]; then
  set --
  while IFS= read -r line || [ -n "$line" ]; do
    echo "[VM-START] Arg: $line" > /dev/console
    set -- "$@" "$line"
  done < /.runcvm/entrypoint
else
  echo "[VM-START] No entrypoint found, sleeping" > /dev/console
  set -- /bin/sleep 3600
fi

# Execute
if [ -n "$additionalGids" ]; then
    exec "$S6_BINARY" -u $uid -g $gid -G "$additionalGids" "$@"
else
    exec "$S6_BINARY" -u $uid -g $gid "$@"
fi